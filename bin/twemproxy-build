BUILD_DIR=$1
CACHE_DIR=$2

set -e

if [ ! -f $BUILD_DIR/twemproxy-$TWEMPROXY_VERSION.tar.gz ]; then
  wget -q -O $BUILD_DIR/twemproxy-$TWEMPROXY_VERSION.tar.gz https://github.com/twitter/twemproxy/archive/v$TWEMPROXY_VERSION.tar.gz
fi

tar zxf $BUILD_DIR/twemproxy-$TWEMPROXY_VERSION.tar.gz

cd twemproxy-$TWEMPROXY_VERSION
cp configure.ac configure
chmod +x configure
./configure --prefix=$CACHE_DIR/twemproxy
make
make install

cd /

if [ ! -f $BUILD_DIR/stunnel-$STUNNEL_VERSION.tar.gz ]; then
  wget -q --no-check-certificate -O $BUILD_DIR/stunnel-$STUNNEL_VERSION.tar.gz https://www.stunnel.org/downloads/stunnel-$STUNNEL_VERSION.tar.gz
  # cert is for mirt.net, which does not match stunnel.org
fi

tar zxf $BUILD_DIR/stunnel-$STUNNEL_VERSION.tar.gz

cd stunnel-$STUNNEL_VERSION
./configure --prefix=$CACHE_DIR/stunnel
make
make install